<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="./style1.css">
  <title>DC-DC simulator</title>
</head>

<body>
  <header>
    <h2 class="heading-6">DC-DC simulator demo</h2>
  </header>
</body>

<body>
  <div class="main">
    <div class="contentA">
      <table class="table1">
        <tr>
          <th scope="col">Series</th>
          <th scope="col">
            <select id="series-select" name="series" size="1">
              <option value="S-19902/3">S-19902/19903</option>
              <option value="S-19904/5">S-19904/19905</option>
              <option value="S-19912/3">S-19912/19913</option>
              <option value="S-19914/5">S-19914/19915</option>
              <option value="S-19932/3">S-19932/19933</option>
              <option value="S-19934/5">S-19934/19935</option>
              <option value="S-19942/3">S-19942/19943</option>
              <option value="S-19944/5">S-19944/19945</option>

              <!--config_values
              "config_vin": operate Voltage
              "config_iout": operate Current
              "config_ssfm": SSFM Enable/Disable
              "config_control": control option
              "config_tr": 立ち上がり時間
              "config_tf": 立ち下がり時間
              "config_tdd1": ライズデッドタイム
              "config_tdd2": フォールデッドタイム
              "config_Qg1" : ハイサイドゲート電荷
              "config_Qg2" : ハイサイドゲート電荷 -->
            </select>
          </th>
          <th id=config_control>S-19912=PWM, S-19913=PWM/PFM</th>
        </tr>

        <tr>
          <th colspan="3" style="background-color: #e0f7fa;">Condition</th>
        </tr>

        <tr>
          <th>VIN[V]</th>
          <td><input type="number" id="vin" value="12"></td>
          <th id=config_vin>operate 4V to 36V</th>
        </tr>

        <tr>
          <th>VOUT[V]</th>
          <td><input type="number" id="vout" value="5"></td>
          <th></th>
        </tr>

        <tr>
          <th>IOUT[A]</th>
          <td><input type="number" id="iout" value="1.0" step="0.1"></td>
          <th id=config_iout>operate under 0.6A</th>
        </tr>

        <tr>
          <th>fsw</th>
          <td>
            <input type="radio" name="fsw" id="fsw_400" value="400" checked>400kHz
            <label class="check_fsw" for="fsw_400"></label>

            <input type="radio" name="fsw" id="fsw_2200" value="2200">2.2MHz
            <label class="check_fsw" for="fsw_2200"></label>
          </td>
          <th></th>
        </tr>

        <tr>
          <th>SSFM</th>
          <th id=config_ssfm>Enable</th>
          <th>Spectrum spread</th>
        </tr>

        <tr>
          <th colspan="3" style="background-color: #e0f7fa;">External Compornents</th>
        </tr>

        <tr>
          <th>L[uH]</th>
          <td><input type="number" id="ind" value="6.8"></td>
          <th></th>
        </tr>

        <tr>
          <th>Cout[uF]</th>
          <td><input type="number" id="cout" value="10"></td>
          <th>10uF≤Cout≤200uF is recommended</th>
        </tr>

        <tr>
          <th>Creg[uF]</th>
          <td><input type="number" id="creg" value="1" readonly disabled class="no-spin"></td>
          <th>1uF is recommended</th>
        </tr>

        <tr>
          <th>RFB1[kΩ]</th>
          <td><input type="number" id="rfb1" value="84" readonly disabled class="no-spin"></td>
          <th></th>
        </tr>

        <tr>
          <th>RFB2[kΩ]</th>
          <td><input type="number" id="rfb2" value="15"></td>
          <th>Approximately 15kΩ is recommended</th>
        </tr>

        <tr>
          <th>Cfb[nF]</th>
          <td><input type="number" id="cfb" value="" readonly disabled class="no-spin"></td>
          <th>Recommended value</th>
        </tr>
      </table>
    </div>

    <div class="right">
      <div class="tab-container">
        <div class="tabs">
          <button class="tab-button" onclick="openCanvasTab(event, 'tab1')">Schematic</button>
          <button class="tab-button" onclick="openCanvasTab(event, 'tab2')">Waveform</button>
          <button class="tab-button" onclick="openCanvasTab(event, 'tab3')">Efficiency</button>
        </div>

        <!-- タブ1: Schematic -->
        <div id="tab1" class="tab-content">
          <img src="./img/test1.png" width="500" height="300">
        </div>

        <!-- タブ2: waveform -->
        <div id="tab2" class="tab-content">
          <canvas id="canvas" width="500" height="300" style="border:1px solid #000;"></canvas>
        </div>

        <!-- タブ3: Efficiency -->
        <div id="tab3" class="tab-content">
          <canvas id="canvas2" width="500" height="300" style="border:1px solid #000;"></canvas>
        </div>
      </div>


      <div class="contentC">
        <table class="table2">

          <tr>
            <th colspan="3" style="background-color: #e0f7fa;">Operation Condition</th>
          </tr>

          <tr>
            <th>Duty[%]</th>
            <label for="duty"></label>
            <td><input type="number" id="duty" readonly class="no-spin"></td>
            <th></th>
          </tr>

          <tr>
            <th>On time[us]</th>
            <td><input type="number" id="ontime" readonly class="no-spin"></td>
            <th id=config_ton>set On time > 0.08us</th>
          </tr>

          <tr>
            <th>Peak Inductor Current[A]</th>
            <td><input type="number" id="peak_current" readonly class="no-spin"></td>
            <th></th>
          </tr>

          <tr>
            <th>Current Ripple[A]</th>
            <td><input type="number" id="Current_ripple" readonly class="no-spin"></td>
            <th></th>
          </tr>

          <tr>
            <th>ΔVout[mV]</th>
            <td><input type="number" id="dvout" readonly class="no-spin"></td>
            <th></th>
          </tr>

          <tr>
            <th>fz[kHz]</th>
            <td><input type="number" id="fz" readonly class="no-spin"></td>
            <th></th>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- タブ切り替え -->
  <script>
    function openCanvasTab(evt, tabName) {
      let i, tabcontent, tabbuttons;

      // すべてのタブコンテンツを非表示にする
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      // すべてのタブボタンのアクティブクラスを削除
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
      }

      // 選択されたタブを表示し、ボタンをアクティブにする
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }

    // 初期表示はタブ2（Graph 1 / canvas1）を開く
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementsByClassName("tab-button")[1].click(); // タブ2を開く
    });
  </script>

  <!-- series_configの読み込み -->
  <script>
    async function loadSeriesData() {
      const response = await fetch("series_config.json");
      const seriesData = await response.json();

      let selectElement = document.getElementById("series-select");
      let ControlElement = document.getElementById("config_control");
      let VinElement = document.getElementById("config_vin");
      let IoutElement = document.getElementById("config_iout");
      let SsfmElement = document.getElementById("config_ssfm");

      function updateValues() {
        let selectedSeries = selectElement.value;
        ControlElement.textContent = seriesData[selectedSeries].config_control;
        VinElement.textContent = seriesData[selectedSeries].config_vin;
        IoutElement.textContent = seriesData[selectedSeries].config_iout;
        SsfmElement.textContent = seriesData[selectedSeries].config_ssfm;
      }

      selectElement.addEventListener("change", updateValues);
      updateValues(); // 初期化
    }

    loadSeriesData();
  </script>

  <!-- 動作条件の計算、およびwaveform chart描写 -->
  <script type="module">
    const start = performance.now();
    import init, { wasm_dccal_result, Chart } from './pkg/wasm_dcdc.js';

    async function main() {
      await init(); // Rust-WASMモジュールの初期化

      const vinInput = document.getElementById("vin");
      const voutInput = document.getElementById("vout");
      const ioutInput = document.getElementById("iout");
      const fswRadios = document.querySelectorAll('input[name="fsw"]');
      const indInput = document.getElementById("ind");
      const coutInput = document.getElementById("cout");
      const rfb2Input = document.getElementById("rfb2");
      const canvas = document.getElementById("canvas");
      let dil_on, dil_off, intercept_on, intercept_off, period, ontime_cha;

      const dccal = () => {
        //入力値の数値変換
        const vin = parseFloat(vinInput.value) || 0;
        const vout = parseFloat(voutInput.value) || 0;
        const iout = parseFloat(ioutInput.value) || 0;
        let fsw = 0;
        fswRadios.forEach(radio => {
          if (radio.checked) {
            fsw = parseFloat(radio.value) * Math.pow(10, 3); // kHz → Hz に変換
          }
        });
        const ind = parseFloat(indInput.value) * Math.pow(10, -6) || 0;
        const cout = parseFloat(coutInput.value) || 0;
        const rfb2 = parseFloat(rfb2Input.value) || 0;

        const result = wasm_dccal_result(vin, vout, iout, fsw, ind, cout, rfb2);
              /* console.log("Duty Cycle:", result.duty); */
              console.log([result.duty, result.period, result.ontime, result.dil_on, result.dil_off, result.intercept_on, result.intercept_off, result.current_top, result.current_bottom, result.ro, result.rfb1, result.fz, result.cfb, result.dvout]);
              
        //出力
        const dutyOut = (result.duty) * Math.pow(10, 2) || 0;
        duty.value = dutyOut.toFixed(1);

        const ontimeOut = (result.ontime) * Math.pow(10, 6) || 0;
        ontime.value = ontimeOut.toFixed(2);

        const Current_topOut = (result.current_top) || 0;
        peak_current.value = Current_topOut.toFixed(2);

        const Current_rippleOut = (result.current_top - result.current_bottom) || 0;
        Current_ripple.value = Current_rippleOut.toFixed(2);

        const Rfb1 = (result.rfb1) || 0;
        rfb1.value = Rfb1.toFixed(2);

        const fzOut = (result.fz) * Math.pow(10, 3)|| 0;
        fz.value = fzOut.toFixed(2);

        const cfbOut = (result.cfb) * Math.pow(10, 3)|| 0;
        cfb.value = cfbOut.toFixed(2);

        const dvoutOut = (result.dvout) * Math.pow(10, 9)|| 0;
        dvout.value = dvoutOut.toFixed(2);

        //for waveform chart
        dil_on = result.dil_on;
        dil_off = result.dil_off;
        intercept_on = result.intercept_on;
        intercept_off = result.intercept_off;
        ontime_cha = (result.ontime);
        period = (result.period) * Math.pow(10, 6) || 0;
        /*      console.log("dil_on_chart:", dil_on);
                console.log("dil_off_chart:", dil_off);
                console.log("intercept_on:", intercept_on);
                console.log("intercept_off:", intercept_off);
                console.log("ontime_chart:", ontime_cha);
                console.log("period_chart:", period); */
        Chart.coil_current(canvas, dil_on, dil_off, intercept_on, intercept_off, ontime_cha, period, 3.0, "u");
      };

      /* イベントリスナー */
      vinInput.addEventListener("input", dccal);
      voutInput.addEventListener("input", dccal);
      ioutInput.addEventListener("input", dccal);
      indInput.addEventListener("input", dccal);
      coutInput.addEventListener("input", dccal);
      rfb2Input.addEventListener("input", dccal);

      fswRadios.forEach(radio => {
        radio.addEventListener("change", dccal);
      });

      dccal();
    }

    main().catch(console.error);

    const end = performance.now();
    console.log(end - start);
  </script>


        
<!-- effiency描写 -->
<script type="module">
  import init, { wasm_eff_result, Chart } from './pkg/wasm_dcdc.js';
  const response = await fetch("series_config.json");
  const seriesData = await response.json();

  async function main2() {
    await init();
      let trElement = document.getElementById("config_tr");
      let tfElement = document.getElementById("config_tf");
      let tdd1Element = document.getElementById("config_tdd1");
      let tdd2Element = document.getElementById("config_tdd2");
      let Qg1Element = document.getElementById("config_Qg1");
      let Qg2Element = document.getElementById("config_Qg2");

  Chart.coil_current(canvas2, dil_on, dil_off, intercept_on, intercept_off, ontime_cha, period, 3.0, "u");


  /*動作条件の警告
  <script>
  async function loadSeriesData() {
    const response = await fetch("series_config.json");
    const seriesData = await response.json();

    let selectElement = document.getElementById("series-select");
    let ontimeElement = document.getElementById("ontime");
    let configTonElement = document.getElementById("config_ton");

    function updateValues() {
      let selectedSeries = selectElement.value;
      let configTon = seriesData[selectedSeries]?.config_ton || 0.08; // デフォルト値

      configTonElement.textContent = `set On time > ${configTon}us`;

      // `ontime` の値を監視して背景色を変更
      function checkOntime() {
        let ontimeValue = parseFloat(ontimeElement.value) || 0;
        console.log("ontimeRe:", ontimeValue);
        if (ontimeValue < configTon) {
          ontimeElement.style.backgroundColor = "red"; // 規定値超過時
        } else {
          ontimeElement.style.backgroundColor = ""; // 通常時
        }
      }

      // `ontime` の変更を監視 ！ここ修正
      ontimeElement.addEventListener("input", checkOntime);
      checkOntime(); // 初期チェック
    }

    selectElement.addEventListener("change", updateValues);
    updateValues(); // 初期化
  } 

  loadSeriesData();
  </script>
  */
</body>

</html>